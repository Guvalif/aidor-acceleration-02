発展課題解答 - アナログセンサを扱う
-------------------------------------------------------------------------------

**Q.**

現状のプログラムでは、測定された値を全て電圧値に比例する数値 (0～4095) でそのまま表示していますが、
これを明るさ (Lux) や気温 (℃) で表示するにはどうすれば良いでしょうか？

- [照度センサの抵抗特性](http://www.kyohritsu.jp/eclib/OTHER/CATALOG/SENSOR/sen9006.pdf)
- [温度センサ (103AT-2) の抵抗特性](http://www.kyohritsu.jp/eclib/OTHER/CATALOG/SENSOR/atthermistor.pdf)
- それぞれのセンサには、10kΩの抵抗を直列に接続しています

**A.**

まず、アナログセンサにおいて測りたいものが電圧に変わるメカニズムを掘り下げてみます。

より厳密に今回使用しているアナログセンサについて言うと、各測定対象の変化に応じて**抵抗値**が変化しています。
ここで、それぞれのセンサには10kΩの抵抗が直列に接続され、なおかつ5Vの電圧が全体に印加されています。
そして、センサと抵抗の接続点を測定点とし、これをアナログセンサの指示値として読み取っています。

![](.assets/analog-sensor.png)

例えば照度センサにおいて：

- 明るい (10Lux) 時、抵抗値は10kΩ程度 ⇒ 測定点の電圧値は `5V * 10kΩ / (10kΩ + 10kΩ) = 2.5V`
- 暗い (0Lux) 時、抵抗値は1MΩ程度 ⇒ 測定点の電圧値は `5V * 10kΩ / (10kΩ + 1MΩ) ~= 0.05V`

となります。

今回、Raspberry Piでは0～5Vの電圧を0～4095の数値として読み出せるのでした。これより：

- 2048の数値を測定値として読み出した ⇒ 2048 := 2.5V ⇒ 2.5Vのとき10Lux
- 41の数値を測定値として読み出した ⇒ 41 := 0.05V ⇒ 0.05Vのとき0Lux

以上のように、測定値から実際の単位における値を得ることができました。

同様な方法で、その他のアナログセンサについても実際の単位への変換を考えることができます。


発展課題解答 - デジタルセンサを扱う
-------------------------------------------------------------------------------

**Q.**

現状のプログラムでは、測定された値を1か0でそのまま表示していますが、
これを"Yes"，"No"で表示するにはどうすれば良いでしょうか？

**A.**

- `digitalRead(MOTION_PIN)` が `1` ならば、`print('Yes')`
- `digitalRead(MOTION_PIN)` が `0` ならば、`print('No')`

上記のように、デジタルセンサの測定結果に応じて、
実行する命令を切り替えることができれば、解答を得ることができます。

このような処理を**条件分岐**と呼び、Pythonでは `if` という命令でこれを記述できます。

具体的には以下のような記述が実装例の1つです：

```python
...

# メインループ
# =============================================================================
while True:
    if digitalRead(MOTION_PIN) == 1:
        print('Yes')

    else:
        print('No')

    sleep(1)
```

ここで、`==` は左辺と右辺が等しいかを調べる命令です。

今回は `else` という命令も併せて使用し、最初の条件が満たされなかった時，
すなわち `digitalRead(MOTION_PIN) == 0` だったときの処理はそちらに記述しています。


発展課題解答 - USBカメラ (画像センサ) を扱う
-------------------------------------------------------------------------------

**Q.**

現状のプログラムでは、毎回同じ名前で画像を保存していますが、
これを現在時刻を含んだファイル名で保存するにはどうすれば良いでしょうか？

**A.**

サンプルプログラムの中では、`from time import sleep` とし、
時間に関する命令をまとめた `time` から、一定時間を待つ `sleep` 命令を読み込んで使用していました。

もちろん、`time` は時間に関する命令をまとめたものですから、
この中には現在時刻を取得する命令が存在し、`time` という名前で用意されています。
**(命令群としての `time` と、1命令としての `time` は別物であることに注意しましょう！)**

これを使用して、`imwrite` 命令にファイル名を指示するときに、
`time` 命令で取得した時間を付け加えれば、解答を得ることができます。

具体的には以下のような記述が実装例の1つです：

```python
# 外部プログラムの読み込み
# =============================================================================
from time import sleep, time

...

# メインループ
# =============================================================================
while True:
    result, frame = camera.read()

    imwrite('frame-' + str(time()) + '.jpg', frame)

    sleep(1)
```

ここで、`'frame-' + str(time()) + '.jpg'` は3つの文字列を連結して、1つの文字列にしています。
Pythonでは、文字列同士は `+` で連結することができます。

また、`str` 命令は文字列ではないものを文字列に変換してくれる命令です。
`time` 命令は数字で現在時刻を返してくるので、`str` 命令で文字列にしています。

ここで、`time` 命令で返される現在時刻はコンピュータにとっては扱いやすい形式ですが、
人間にとっては読みづらい形式となっています。

`YYYY_MM_DD-HH_MM_SS` のような書式で現在時刻を取得したい場合は、`time` より追加で：

- `localtime`: 時刻を、時差を考慮した現地時刻に変換する命令
- `strftime`: 時刻を、指定した書式の文字列に変換する命令

上記それぞれをインポートし、以下のように記述します：

```python
# 外部プログラムの読み込み
# =============================================================================
from time import sleep, time, localtime, strftime

...

# メインループ
# =============================================================================
while True:
    result, frame = camera.read()

    imwrite('frame-' + strftime('%Y_%m_%d-%H_%M_%S', localtime(time())) + '.jpg', frame)

    sleep(1)
```


発展課題解答 - サーボモータを動かす
-------------------------------------------------------------------------------

**Q.**

ある角度に向けてなめらかにサーボモータを動かすにはどうすれば良いでしょうか？

**A.**

サンプルプログラムの中では：

- ある角度にサーボモータを動かす
- 1秒待つ
- 先ほどとは大きく異なる角度にサーボモータを動かす
- 1秒待つ

という実装が記述されているため、人間から見てギクシャクと動いているように見えてしまいます。

では、以下のようであればどうでしょうか？：

- ある角度にサーボモータを動かす
- 0.1秒待つ
- 先ほどとは少しだけ異なる角度にサーボモータを動かす
- 0.1秒待つ
- (これを繰り返す...)

この実装例では、人間から見て変化はほとんど無いはずです。
このように、目的の角度に向けて少し動かして少し待つを繰り返すことで、解答を得ることができます。

具体的には以下のような記述が実装例の1つです：

```python
...

# メインループ
# =============================================================================
while True:
    pwmWrite(SERVO_PIN, 26)
    sleep(0.1)
    
    pwmWrite(SERVO_PIN, 31)
    sleep(0.1)
    
    pwmWrite(SERVO_PIN, 36)
    sleep(0.1)
    
    pwmWrite(SERVO_PIN, 41)
    sleep(0.1)
    
    pwmWrite(SERVO_PIN, 46)
    sleep(0.1)
    
    pwmWrite(SERVO_PIN, 51)
    sleep(0.1)
    
    pwmWrite(SERVO_PIN, 56)
    sleep(0.1)
    
    pwmWrite(SERVO_PIN, 61)
    sleep(0.1)
    
    pwmWrite(SERVO_PIN, 66)
    sleep(0.1)

    pwmWrite(SERVO_PIN, 71)
    sleep(0.1)

    pwmWrite(SERVO_PIN, 74)
    sleep(1)
```

もちろん、毎回このような記述を行うのは冗長ですから、
繰り返し部分を抽出し、1つにまとめあげ簡潔に記述することも可能です。


発展課題解答 - センサ・アクチュエータのインターネットリソース化
-------------------------------------------------------------------------------

**Q.**

現状のプログラムでは、同時に複数のクライアントから各URIにアクセスしても、
1つ1つのクライアントへ向けた処理が終了するまでは、HTTPサーバが応答を返すことができません。
どのように変更を行えば、同時アクセスを捌けるようになるでしょうか？

**A.**

端的に言えば、これはこのPythonプログラム上でHTTPサーバが1つしか起動していないために起こる問題です。
同時にいくつかのアクセスを捌きたいのであれば、複数並列でHTTPサーバを起動すれば良いです。

Python + `bottle` の組み合わせでこれを行う場合、
追加で `paste` というライブラリを使用すると楽です：

```python
...

from paste import httpserver

...

# URIの定義・HTTPサーバの起動
# =============================================================================

...

httpserver.serve(router, host='0.0.0.0', port=80)
```
